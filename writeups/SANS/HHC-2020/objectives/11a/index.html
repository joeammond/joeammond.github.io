
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <meta name="author" content="Joe Ammond (pugpug)">
      
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.2.3">
    
    
      
        <title>Naughty/Nice List with Blockchain Investigation Part 1 - SANS HHC 2020 writeup</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.3b61ea93.min.css">
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../../css/print.css">
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#objective-11a-naughtynice-list-with-blockchain-investigation-part-1" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="../.." title="SANS HHC 2020 writeup" class="md-header-nav__button md-logo" aria-label="SANS HHC 2020 writeup">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      <div class="md-header-nav__ellipsis">
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            SANS HHC 2020 writeup
          </span>
        </div>
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            
              Naughty/Nice List with Blockchain Investigation Part 1
            
          </span>
        </div>
      </div>
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    




<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="SANS HHC 2020 writeup" class="md-nav__button md-logo" aria-label="SANS HHC 2020 writeup">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    SANS HHC 2020 writeup
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      



  <li class="md-nav__item">
    <a href="http://ammond.org" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      



  <li class="md-nav__item">
    <a href="../.." class="md-nav__link">
      Welcome
    </a>
  </li>

    
      
      
      


  


  
  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Objectives
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Objectives" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon"></span>
        Objectives
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          



  <li class="md-nav__item">
    <a href="../1/" class="md-nav__link">
      Uncover Santa's Gift List
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../2/" class="md-nav__link">
      Investigate S3 Bucket
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../3/" class="md-nav__link">
      Point-of-Sale Password Recovery
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../4/" class="md-nav__link">
      Operate the Santavator
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../5/" class="md-nav__link">
      Open HID Lock
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../6/" class="md-nav__link">
      Splunk Challenge
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../7/" class="md-nav__link">
      Solve the Sleigh's CAN-D-BUS Problem
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../8/" class="md-nav__link">
      Broken Tag Generator
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../9/" class="md-nav__link">
      ARP Shenanigans
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../10/" class="md-nav__link">
      Defeat Fingerprint Sensor
    </a>
  </li>

        
          
          
          


  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Naughty/Nice List with Blockchain Investigation Part 1
        <span class="md-nav__icon md-icon"></span>
      </label>
    
    <a href="./" class="md-nav__link md-nav__link--active">
      Naughty/Nice List with Blockchain Investigation Part 1
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#hints" class="md-nav__link">
    Hints
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#solution" class="md-nav__link">
    Solution
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#answer" class="md-nav__link">
    Answer
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../11b/" class="md-nav__link">
      Naughty/Nice List with Blockchain Investigation Part 2
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      



  
  <li class="md-nav__item md-nav__item--nested">
    
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" >
    
    <label class="md-nav__link" for="nav-4">
      Fun stuff
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Fun stuff" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon"></span>
        Fun stuff
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          



  <li class="md-nav__item">
    <a href="../../fun/portrait/" class="md-nav__link">
      Santa's portrait poem
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../fun/secret-garden/" class="md-nav__link">
      The Secret Garden
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../fun/nail/" class="md-nav__link">
      The Nail
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      



  <li class="md-nav__item">
    <a href="../../conclusion/" class="md-nav__link">
      Conclusion
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#hints" class="md-nav__link">
    Hints
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#solution" class="md-nav__link">
    Solution
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#answer" class="md-nav__link">
    Answer
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset"><a class="md-content__button md-icon" download href="11a.pdf" title="PDF Export"><svg style="height: 1.2rem; width: 1.2rem;" viewBox="0 0 384 512" xmlns="http://www.w3.org/2000/svg"><path d="M224 136V0H24C10.7 0 0 10.7 0 24v464c0 13.3 10.7 24 24 24h336c13.3 0 24-10.7 24-24V160H248c-13.2 0-24-10.8-24-24zm76.45 211.36l-96.42 95.7c-6.65 6.61-17.39 6.61-24.04 0l-96.42-95.7C73.42 337.29 80.54 320 94.82 320H160v-80c0-8.84 7.16-16 16-16h32c8.84 0 16 7.16 16 16v80h65.18c14.28 0 21.4 17.29 11.27 27.36zM377 105L279.1 7c-4.5-4.5-10.6-7-17-7H256v128h128v-6.1c0-6.3-2.5-12.4-7-16.9z"></path></svg></a>
              
                
                
                <h1 id="objective-11a-naughtynice-list-with-blockchain-investigation-part-1">Objective 11a: Naughty/Nice List with Blockchain Investigation Part 1<a class="headerlink" href="#objective-11a-naughtynice-list-with-blockchain-investigation-part-1" title="Permanent link">#</a></h1>
<blockquote>
<p>Even though the chunk of the blockchain that you have ends with block 129996, can you predict the nonce for block 130000? Talk to Tangle Coalbox in the Speaker UNpreparedness Room for tips on prediction and Tinsel Upatree for more tips and <a href="https://download.holidayhackchallenge.com/2020/OfficialNaughtyNiceBlockchainEducationPack.zip">tools</a>. (Enter just the 16-character hex value of the nonce)</p>
<p><code>Difficulty: 5/5</code></p>
</blockquote>
<h2 id="hints">Hints<a class="headerlink" href="#hints" title="Permanent link">#</a></h2>
<blockquote>
<p>If you have control over to bytes in a file, it's easy to create MD5 <a href="https://github.com/corkami/collisions">hash collisions</a>. Problem is: there's that nonce that he would have to know ahead of time.</br></p>
</blockquote>
<h2 id="solution">Solution<a class="headerlink" href="#solution" title="Permanent link">#</a></h2>
<p>These last two objectives are the most difficult in the entire challenge. We're given
a shard of Santa's "Naughty/Nice" blockchain, and Python code that allows to process
the chain and individual blocks contained within. Watching Professor Qwerty Petabyte's
<a href="https://www.youtube.com/watch?v=7rLMl88p-ec">talk</a> on the Naughty/Nice blockchain is
essential to understanding this objective.</p>
<p>In this objective, we're tasked with finding the <code>nonce</code> for a block beyond the end of the
blockchain shard we've been given. The <code>nonce</code> is a 64-bit random value added to the beginning of
each block to avoid hash collisions in the MD5 hash algorithm used for verifying the integrity
of the blockchain:</p>
<div class="highlight"><pre><span></span><code><span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span>
<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nonce</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># genesis block</span>
<span class="k">else</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nonce</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mh">0xFFFFFFFFFFFFFFFF</span><span class="p">)</span>
</code></pre></div>
<p>The first block in a chain (the 'genesis block') has a nonce of zero,
whereas any subsequent block has a random 64-bit value added, generated from
Python's <code>random.randrange()</code> function.  However, from watching Tom Liston's
<a href="http://www.youtube.com/watch?v=Jo5Nlbqd-Vg">talk</a> on how the Pseudo-Random Number Generator
"Mersenne Twister" generates numbers, we know if we have 624 consecutive numbers from the PRNG we
can clone the state of the generator and use the clone to predict what the PRNG output will be. </p>
<p>One challenge is that the implementation of the Mersenne Twister in Python returns 32-bit
results, but the <code>nonce</code> generated for the block is a 64-bit value. To determine how the
Python function <code>randrange()</code> generates randum values with &gt;32 bits, we have to dig into the 
source for the Python <code>random</code> library. In <a href="https://github.com/python/cpython/blob/master/Lib/random.py">https://github.com/python/cpython/blob/master/Lib/random.py</a>, we can find the definition for
the function <code>randrange()</code> starting at line 292: After some boilerplate type and argument
checking, the relevant call to get random data is:</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="n">istep</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span> <span class="o">+</span> <span class="n">istep</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">istep</span>
<span class="k">elif</span> <span class="n">istep</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span> <span class="o">+</span> <span class="n">istep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">istep</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;zero step for randrange()&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;empty range for randrange()&quot;</span><span class="p">)</span>
<span class="k">return</span> <span class="n">istart</span> <span class="o">+</span> <span class="n">istep</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_randbelow</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</code></pre></div>
<p><code>n</code> is the upper limit of value to return. So <code>randrange</code> calls <code>_randbelow</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">_randbelow_with_getrandbits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="s2">&quot;Return a random int in the range [0,n).  Returns 0 if n==0.&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">getrandbits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getrandbits</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span>  <span class="c1"># don&#39;t use (n-1) here because n can be 1</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">getrandbits</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="c1"># 0 &lt;= r &lt; 2**k</span>
    <span class="k">while</span> <span class="n">r</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">getrandbits</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">r</span>
</code></pre></div>
<p>The source to <code>getrandbits</code> is in <a href="https://github.com/python/cpython/blob/master/Modules/_randommodule.c">https://github.com/python/cpython/blob/master/Modules/_randommodule.c</a>:</p>
<div class="highlight"><pre><span></span><code><span class="cm">/*[clinic input]</span>
<span class="cm">_random.Random.getrandbits</span>
<span class="cm">  self: self(type=&quot;RandomObject *&quot;)</span>
<span class="cm">  k: int</span>
<span class="cm">  /</span>
<span class="cm">getrandbits(k) -&gt; x.  Generates an int with k random bits.</span>
<span class="cm">[clinic start generated code]*/</span>

<span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="n">_random_Random_getrandbits_impl</span><span class="p">(</span><span class="n">RandomObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">int</span> <span class="n">k</span><span class="p">)</span>
<span class="cm">/*[clinic end generated code: output=b402f82a2158887f input=8c0e6396dd176fc0]*/</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">words</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">r</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">wordarray</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">result</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PyErr_SetString</span><span class="p">(</span><span class="n">PyExc_ValueError</span><span class="p">,</span>
                        <span class="s">&quot;number of bits must be non-negative&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PyLong_FromLong</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;=</span> <span class="mi">32</span><span class="p">)</span>  <span class="cm">/* Fast path */</span>
        <span class="k">return</span> <span class="n">PyLong_FromUnsignedLong</span><span class="p">(</span><span class="n">genrand_uint32</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="n">k</span><span class="p">));</span>

    <span class="n">words</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">wordarray</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">PyMem_Malloc</span><span class="p">(</span><span class="n">words</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">wordarray</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PyErr_NoMemory</span><span class="p">();</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Fill-out bits of long integer, by 32-bit words, from least significant</span>
<span class="cm">       to most significant. */</span>
<span class="cp">#if PY_LITTLE_ENDIAN</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">words</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">k</span> <span class="o">-=</span> <span class="mi">32</span><span class="p">)</span>
<span class="cp">#else</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">words</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">,</span> <span class="n">k</span> <span class="o">-=</span> <span class="mi">32</span><span class="p">)</span>
<span class="cp">#endif</span>
    <span class="p">{</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">genrand_uint32</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span>
            <span class="n">r</span> <span class="o">&gt;&gt;=</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="n">k</span><span class="p">);</span>  <span class="cm">/* Drop least significant bits */</span>
        <span class="n">wordarray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">_PyLong_FromByteArray</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">wordarray</span><span class="p">,</span> <span class="n">words</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
                                   <span class="n">PY_LITTLE_ENDIAN</span><span class="p">,</span> <span class="mi">0</span> <span class="cm">/* unsigned */</span><span class="p">);</span>
    <span class="n">PyMem_Free</span><span class="p">(</span><span class="n">wordarray</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>The relevant code for returning random values &gt;32-bits long is in the <code>for()</code> loop: 32-bit random
values are generated, then filled into an array least-significant bits to most-significant bits. 
The <code>nonce</code> values therefore are the result of two calls to the PRNG for 32-bit values, the
second shifted 32 bits and added to the first. This is equivalent to <code>random.randrange(0xFFFFFFFFFFFFFFFF)</code>.</p>
<div class="highlight"><pre><span></span><code><span class="n">r1</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mh">0xFFFFFFFF</span><span class="p">)</span>
<span class="n">r2</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mh">0xFFFFFFFF</span><span class="p">)</span>

<span class="n">nonce</span> <span class="o">=</span> <span class="p">((</span><span class="n">r2</span><span class="o">&lt;&lt;</span><span class="mi">32</span><span class="p">)</span> <span class="o">+</span> <span class="n">r1</span><span class="p">)</span>
</code></pre></div>
<p>Armed with this, we can write some code to:</p>
<ul>
<li>Retrieve all the <code>nonce</code> values from the blockchain shard</li>
<li>Split each 64-bit value into it's 32-bit components</li>
<li>Use the last 624 values to re-create the Python PRNG state</li>
<li>Run our PRTG forward and generate <code>nonce</code> values for blocks, until we reach block <code>130000</code></li>
</ul>
<p>Copying <code>blockchain.dat</code>, <code>naughty_nice.py</code>, <code>official_public.pem</code> and <code>mt19937.py</code> to a directory,
we can run the following Python code to do the above:</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env python3</span>

<span class="c1"># (c) 2020 Joe Ammond &#39;pugpug&#39; (@joeammond)</span>

<span class="kn">from</span> <span class="nn">mt19937</span> <span class="kn">import</span> <span class="n">mt19937</span><span class="p">,</span> <span class="n">untemper</span>
<span class="kn">from</span> <span class="nn">naughty_nice</span> <span class="kn">import</span> <span class="n">Chain</span><span class="p">,</span> <span class="n">Block</span>

<span class="c1"># Load the blockchain shard</span>
<span class="n">shard</span> <span class="o">=</span> <span class="n">Chain</span><span class="p">(</span><span class="n">load</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;blockchain.dat&#39;</span><span class="p">)</span>

<span class="c1"># Pull all the nonces from the blockchain, split them into their</span>
<span class="c1"># component 32-bit values, and append them to the list of seeds</span>
<span class="n">prng_seeds</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shard</span><span class="o">.</span><span class="n">blocks</span><span class="p">)):</span>
    <span class="n">nonce</span> <span class="o">=</span> <span class="n">shard</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">nonce</span>
    <span class="n">r1</span> <span class="o">=</span> <span class="n">nonce</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">nonce</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span>
    <span class="n">prng_seeds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span>
    <span class="n">prng_seeds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>

<span class="c1"># Create our own version of an MT19937 PRNG.</span>
<span class="n">myprng</span> <span class="o">=</span> <span class="n">mt19937</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Pull the last 624 seeds for the PRNG</span>
<span class="n">prng_seeds</span> <span class="o">=</span> <span class="n">prng_seeds</span><span class="p">[</span><span class="o">-</span><span class="mi">624</span><span class="p">:]</span>

<span class="c1"># Seed our PRNG</span>
<span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prng_seeds</span><span class="p">)):</span>
    <span class="n">myprng</span><span class="o">.</span><span class="n">MT</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">untemper</span><span class="p">(</span><span class="n">prng_seeds</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>

<span class="c1"># Print the next 10 block nonces. We want the hex value for block 130000</span>
<span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Generating seed for block </span><span class="si">{}</span><span class="s1">: &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">129997</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="n">r1</span> <span class="o">=</span> <span class="n">myprng</span><span class="o">.</span><span class="n">extract_number</span><span class="p">()</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">myprng</span><span class="o">.</span><span class="n">extract_number</span><span class="p">()</span>
    <span class="n">nonce</span> <span class="o">=</span> <span class="p">((</span><span class="n">r2</span><span class="o">&lt;&lt;</span><span class="mi">32</span><span class="p">)</span> <span class="o">+</span> <span class="n">r1</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">nonce</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%016.016x</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nonce</span><span class="p">))</span>
</code></pre></div>
<p>Running this code produces the following output:</p>
<p><img alt="Output from PRNG predictor" src="../../img/11a/o11a-1.png" /></p>
<p>The hexadecimal value for block <code>130000</code> is <code>57066318f32f729d</code>.</p>
<h2 id="answer">Answer<a class="headerlink" href="#answer" title="Permanent link">#</a></h2>
<p><code>57066318f32f729d</code></p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../10/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Defeat Fingerprint Sensor
              </div>
            </div>
          </a>
        
        
          <a href="../11b/" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Naughty/Nice List with Blockchain Investigation Part 2
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Joe Ammond - <a href="http://twitter.com/joeammond">@joeammond</a>
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://twitter.com/joeammond" target="_blank" rel="noopener" title="twitter.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://www.linkedin.com/in/joeammond/" target="_blank" rel="noopener" title="www.linkedin.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.08c56446.min.js"></script>
      <script src="../../assets/javascripts/bundle.6ced434e.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: [],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.8c7e0a7e.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>